# Setup Registry
docker run -d --restart=always -p 5000:5000 -v ~/artifacts/registry:/var/lib/registry --name registry.local registry:2
echo "127.0.0.1 registry.local" | tee -a /etc/hosts

export KO_DOCKER_REPO=ko.local

# Build Knative
export YAML_OUTPUT_DIR=$HOME/artifacts/build
mkdir -p ${YAML_OUTPUT_DIR}
./hack/generate-yamls.sh "/workspaces/serving" "$(mktemp)" $YAML_OUTPUT_DIR/env

# Build Test Images
./test/upload-test-images.sh

# Configure KinD Cluster
# Approach 1
mkdir -p /tmp/etcd
mount -t tmpfs tmpfs /tmp/etcd
kind create cluster --config .devcontainer/kind.yaml --wait 5m

# Approach 2
kind create cluster
rm ./test/config/chaosduck/chaosduck.yaml
source ./test/e2e-common.sh